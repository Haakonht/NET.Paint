<UserControl x:Class="NET.Paint.View.Component.Tools.Controls.ColorPicker"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:converters="clr-namespace:NET.Paint.View.Component.Tools.Converters"
             xmlns:service="clr-namespace:NET.Paint.Drawing.Service;assembly=NET.Paint.Drawing"
             xmlns:customControls="clr-namespace:NET.Paint.Resources.Controls"
             xmlns:local="clr-namespace:NET.Paint.View.Component.Tools.Controls"
             mc:Ignorable="d" 
             d:DesignHeight="250" d:DesignWidth="200" d:Background="White"
             d:DataContext="{d:DesignInstance Type=service:XService, IsDesignTimeCreatable=True}"
             Loaded="HueSlider_Loaded">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="../../../../Resources/Styles/Sliders.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <converters:ColorToHSLConverter x:Key="ColorToHSLConverter"/>
            <converters:HueToSLBackgroundConverter x:Key="HueToSLBackgroundConverter"/>
            <converters:ContrastColorConverter x:Key="ContrastColorConverter"/>

            <Style x:Key="HueSliderStyle" TargetType="{x:Type Slider}" BasedOn="{StaticResource SliderNoTrackStyle}">
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type Slider}">
                            <Grid Height="25">
                                <Border Height="20" BorderThickness="1" BorderBrush="Black" CornerRadius="10">
                                    <Border.Background>
                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                            <GradientStop Color="Red" Offset="0"/>
                                            <GradientStop Color="Yellow" Offset="0.1667"/>
                                            <GradientStop Color="Green" Offset="0.3333"/>
                                            <GradientStop Color="Cyan" Offset="0.5"/>
                                            <GradientStop Color="Blue" Offset="0.6667"/>
                                            <GradientStop Color="Magenta" Offset="0.8333"/>
                                            <GradientStop Color="Red" Offset="1"/>
                                        </LinearGradientBrush>
                                    </Border.Background>
                                    <Track x:Name="PART_Track">
                                        <Track.Thumb>
                                            <Thumb Margin="-2,-1,0,-1">
                                                <Thumb.Template>
                                                    <ControlTemplate TargetType="{x:Type Thumb}">
                                                        <Ellipse Height="20" Width="20" Stroke="Black" StrokeThickness="2">
                                                            <Ellipse.Style>
                                                                <Style TargetType="Ellipse">
                                                                    <Setter Property="Fill" Value="Transparent"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding IsMouseOver, RelativeSource={RelativeSource AncestorType=Thumb}}" Value="True">
                                                                            <Setter Property="Fill">
                                                                                <Setter.Value>
                                                                                    <SolidColorBrush Color="White" Opacity="0.2"/>
                                                                                </Setter.Value>
                                                                            </Setter>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </Ellipse.Style>
                                                        </Ellipse>
                                                    </ControlTemplate>
                                                </Thumb.Template>
                                            </Thumb>
                                        </Track.Thumb>
                                    </Track>
                                </Border>
                            </Grid>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <!-- Alpha Slider Style -->
            <Style x:Key="AlphaSliderStyle" TargetType="{x:Type Slider}" BasedOn="{StaticResource SliderNoTrackStyle}">
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="{x:Type Slider}">
                            <Grid Height="25">
                                <Border Height="20" BorderThickness="1" BorderBrush="Black" CornerRadius="10">
                                    <!-- Checkered background to show transparency -->
                                    <Border.Background>
                                        <DrawingBrush ViewportUnits="Absolute" Viewport="0,0,8,8" TileMode="Tile">
                                            <DrawingBrush.Drawing>
                                                <DrawingGroup>
                                                    <GeometryDrawing Brush="White">
                                                        <GeometryDrawing.Geometry>
                                                            <RectangleGeometry Rect="0,0,8,8"/>
                                                        </GeometryDrawing.Geometry>
                                                    </GeometryDrawing>
                                                    <GeometryDrawing Brush="LightGray">
                                                        <GeometryDrawing.Geometry>
                                                            <GeometryGroup>
                                                                <RectangleGeometry Rect="0,0,4,4"/>
                                                                <RectangleGeometry Rect="4,4,4,4"/>
                                                            </GeometryGroup>
                                                        </GeometryDrawing.Geometry>
                                                    </GeometryDrawing>
                                                </DrawingGroup>
                                            </DrawingBrush.Drawing>
                                        </DrawingBrush>
                                    </Border.Background>
                                    
                                    <!-- Alpha gradient overlay -->
                                    <Border CornerRadius="10">
                                        <Border.Background>
                                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                                <GradientStop Color="Transparent" Offset="0"/>
                                                <GradientStop Offset="1" Color="{Binding SelectedColor, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                            </LinearGradientBrush>
                                        </Border.Background>
                                        <Track x:Name="PART_Track">
                                            <Track.Thumb>
                                                <Thumb Margin="-2,-1,0,-1">
                                                    <Thumb.Template>
                                                        <ControlTemplate TargetType="{x:Type Thumb}">
                                                            <Ellipse Height="20" Width="20" Stroke="Black" StrokeThickness="2">
                                                                <Ellipse.Style>
                                                                    <Style TargetType="Ellipse">
                                                                        <Setter Property="Fill" Value="Transparent"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding IsMouseOver, RelativeSource={RelativeSource AncestorType=Thumb}}" Value="True">
                                                                                <Setter Property="Fill">
                                                                                    <Setter.Value>
                                                                                        <SolidColorBrush Color="White" Opacity="0.2"/>
                                                                                    </Setter.Value>
                                                                                </Setter>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </Ellipse.Style>
                                                            </Ellipse>
                                                        </ControlTemplate>
                                                    </Thumb.Template>
                                                </Thumb>
                                            </Track.Thumb>
                                        </Track>
                                    </Border>
                                </Border>
                            </Grid>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid DataContext="{Binding RelativeSource={RelativeSource AncestorType=UserControl}, Path=.}">
        <ToggleButton x:Name="ColorPickerToggle" Background="{Binding SelectedColor, Converter={StaticResource ColorToBrushConverter}}" IsChecked="{Binding IsOpen, Mode=TwoWay}">
            <TextBlock Text="{Binding SelectedColor}" Foreground="{Binding SelectedColor, Converter={StaticResource ContrastColorConverter}}" Visibility="{Binding NameVisibility, Mode=TwoWay}"/>
        </ToggleButton>

        <Popup Width="200" StaysOpen="False" AllowsTransparency="True" IsOpen="{Binding IsOpen, Mode=TwoWay}" Placement="Top" PlacementTarget="{Binding ElementName=ColorPickerToggle}" HorizontalOffset="18">
            <Border Background="White" BorderBrush="DimGray" BorderThickness="1"
                    MouseLeftButtonDown="Popup_MouseLeftButtonDown"
                    MouseRightButtonDown="Popup_MouseRightButtonDown"
                    MouseMove="Popup_MouseMove"
                    MouseWheel="Popup_MouseWheel">
                <StackPanel Margin="5" Cursor="Arrow">
                    <!-- SL Color Selector -->
                    <Border x:Name="SLBorder" Height="150" BorderThickness="1" BorderBrush="Black"
                             Background="{Binding Value, ElementName=HueSlider, Converter={StaticResource HueToSLBackgroundConverter}}"
                             MouseLeftButtonDown="SLSelector_MouseLeftButtonDown"
                             MouseMove="SLSelector_MouseMove" Cursor="Cross">
                        <Canvas x:Name="SLCanvas">
                            <Ellipse x:Name="SLIndicator" Width="10" Height="10" 
                                      Stroke="White" StrokeThickness="2" 
                                      Fill="Transparent"
                                      Canvas.Left="70" Canvas.Top="70"
                                      IsHitTestVisible="False"/>
                        </Canvas>
                    </Border>

                    <!-- Hue Slider -->
                    <Slider x:Name="HueSlider" Margin="0,5,0,0"
                         Minimum="0" Maximum="360" Value="0"
                         Style="{StaticResource HueSliderStyle}"
                         ValueChanged="HueSlider_ValueChanged"/>

                    <!-- Alpha Slider -->
                    <Slider x:Name="AlphaSlider" Margin="0,5,0,0"
                         Minimum="0" Maximum="1" Value="1"
                         Style="{StaticResource AlphaSliderStyle}"
                         ValueChanged="AlphaSlider_ValueChanged"/>

                    <!-- Color Preview -->
                    <Border Height="25" BorderThickness="1" BorderBrush="Black" Margin="0,5,0,0" CornerRadius="3">
                        <!-- Checkered background -->
                        <Border.Background>
                            <DrawingBrush ViewportUnits="Absolute" Viewport="0,0,8,8" TileMode="Tile">
                                <DrawingBrush.Drawing>
                                    <DrawingGroup>
                                        <GeometryDrawing Brush="White">
                                            <GeometryDrawing.Geometry>
                                                <RectangleGeometry Rect="0,0,8,8"/>
                                            </GeometryDrawing.Geometry>
                                        </GeometryDrawing>
                                        <GeometryDrawing Brush="LightGray">
                                            <GeometryDrawing.Geometry>
                                                <GeometryGroup>
                                                    <RectangleGeometry Rect="0,0,4,4"/>
                                                    <RectangleGeometry Rect="4,4,4,4"/>
                                                </GeometryGroup>
                                            </GeometryDrawing.Geometry>
                                        </GeometryDrawing>
                                    </DrawingGroup>
                                </DrawingBrush.Drawing>
                            </DrawingBrush>
                        </Border.Background>

                        <!-- Color overlay -->
                        <Border Background="{Binding SelectedColor, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource ColorToBrushConverter}}"  CornerRadius="3"/>
                    </Border>
                </StackPanel>

            </Border>
        </Popup>
    </Grid>
</UserControl>
